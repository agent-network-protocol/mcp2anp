# ä¼šè¯ç®¡ç†å®ç°æ€»ç»“

## æœ€ç»ˆå®ç°æ–¹æ¡ˆ

ç»è¿‡ç ”ç©¶ MCP åè®®è§„èŒƒå’Œå®é™…æµ‹è¯•ï¼Œæœ€ç»ˆé‡‡ç”¨**ä»…è¶…æ—¶æœºåˆ¶**çš„ä¼šè¯ç®¡ç†æ–¹æ¡ˆã€‚

## å†³ç­–è¿‡ç¨‹

### åˆå§‹æ–¹æ¡ˆï¼šHTTP DELETE + è¶…æ—¶

æœ€åˆè®¡åˆ’å®ç°ä¸¤ç§ä¼šè¯å…³é—­æ–¹å¼ï¼š
1. HTTP DELETE ç«¯ç‚¹ - å®¢æˆ·ç«¯ä¸»åŠ¨å…³é—­
2. è¶…æ—¶æœºåˆ¶ - æœåŠ¡å™¨è‡ªåŠ¨æ¸…ç†

### åè®®ç ”ç©¶

é€šè¿‡æœç´¢ MCP åè®®è§„èŒƒå‘ç°ï¼š
- MCP åè®®å¯¹ HTTP DELETE çš„æ”¯æŒ**ä¸æ˜ç¡®**
- ä¸åŒæ¥æºçš„ä¿¡æ¯å­˜åœ¨çŸ›ç›¾
- å®é™…æµ‹è¯•ä¸­ DELETE è¯·æ±‚è¢«ä¸­é—´ä»¶æ‹¦æˆª

### æœ€ç»ˆå†³å®š

**ç§»é™¤ HTTP DELETE æ”¯æŒï¼Œä»…ä¿ç•™è¶…æ—¶æœºåˆ¶**

åŸå› ï¼š
1. âœ… MCP åè®®è§„èŒƒä¸æ˜ç¡®æ”¯æŒ HTTP DELETE
2. âœ… è¶…æ—¶æœºåˆ¶å·²è¶³å¤Ÿæ»¡è¶³éœ€æ±‚
3. âœ… ç®€åŒ–å®ç°ï¼Œå‡å°‘å¤æ‚åº¦
4. âœ… é¿å…ä¸ MCP åè®®å±‚å†²çª

## å®ç°ç»†èŠ‚

### 1. ä¼šè¯ç®¡ç†æ¨¡å— (`mcp2anp/session.py`)

#### SessionConfig
```python
class SessionConfig:
    """ä¼šè¯é…ç½®ä¿¡æ¯"""
    def __init__(self, did_document_path: str, private_key_path: str)
```

#### SessionState
```python
class SessionState:
    """ä¼šè¯çŠ¶æ€"""
    - session_id: ä¼šè¯ ID
    - config: DID å‡­è¯é…ç½®
    - anp_crawler: ANPCrawler å®ä¾‹
    - anp_handler: ANPHandler å®ä¾‹
    - created_at: åˆ›å»ºæ—¶é—´
    - last_accessed: æœ€åè®¿é—®æ—¶é—´
    
    æ–¹æ³•ï¼š
    - touch(): æ›´æ–°æœ€åè®¿é—®æ—¶é—´
    - is_expired(timeout): æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
    - initialize(): åˆå§‹åŒ– ANPCrawler å’Œ ANPHandler
```

#### SessionManager
```python
class SessionManager:
    """ä¼šè¯ç®¡ç†å™¨"""
    def __init__(self, timeout=1800, cleanup_interval=300)
    
    æ–¹æ³•ï¼š
    - create_session(config): åˆ›å»ºæ–°ä¼šè¯
    - get_session(session_id): è·å–ä¼šè¯ï¼ˆè‡ªåŠ¨æ›´æ–°è®¿é—®æ—¶é—´ï¼‰
    - remove_session(session_id): åˆ é™¤ä¼šè¯
    - cleanup_expired_sessions(): åå°æ¸…ç†ä»»åŠ¡ï¼ˆå¼‚æ­¥ï¼‰
    - start_cleanup_task(): å¯åŠ¨æ¸…ç†ä»»åŠ¡
    - stop_cleanup_task(): åœæ­¢æ¸…ç†ä»»åŠ¡
```

### 2. æœåŠ¡å™¨é›†æˆ (`mcp2anp/server_remote.py`)

#### å‘½ä»¤è¡Œå‚æ•°
```bash
--session-timeout INTEGER     # ä¼šè¯è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰ï¼Œé»˜è®¤ 1800ï¼ˆ30åˆ†é’Ÿï¼‰
--cleanup-interval INTEGER    # æ¸…ç†ä»»åŠ¡æ‰§è¡Œé—´éš”ï¼ˆç§’ï¼‰ï¼Œé»˜è®¤ 300ï¼ˆ5åˆ†é’Ÿï¼‰
```

#### å¯åŠ¨äº‹ä»¶
```python
@app.on_event("startup")
async def startup_event():
    """æœåŠ¡å™¨å¯åŠ¨æ—¶å¯åŠ¨æ¸…ç†ä»»åŠ¡"""
    session_manager.start_cleanup_task()

@app.on_event("shutdown")
async def shutdown_event():
    """æœåŠ¡å™¨å…³é—­æ—¶åœæ­¢æ¸…ç†ä»»åŠ¡"""
    session_manager.stop_cleanup_task()
```

### 3. ä¼šè¯ç”Ÿå‘½å‘¨æœŸ

```
å®¢æˆ·ç«¯é¦–æ¬¡è¯·æ±‚
    â†“
æœåŠ¡å™¨é‰´æƒ â†’ åˆ›å»º SessionState
    â†“
åˆå§‹åŒ– ANPCrawler å’Œ ANPHandler
    â†“
è¿”å› Mcp-Session-Id å¤´
    â†“
å®¢æˆ·ç«¯åç»­è¯·æ±‚æºå¸¦ Mcp-Session-Id
    â†“
æœåŠ¡å™¨è·å–ä¼šè¯å¹¶æ›´æ–° last_accessed
    â†“
åå°æ¸…ç†ä»»åŠ¡å®šæœŸæ£€æŸ¥
    â†“
åˆ é™¤è¿‡æœŸä¼šè¯ï¼ˆlast_accessed + timeout < nowï¼‰
```

## æµ‹è¯•éªŒè¯

### æµ‹è¯•è„šæœ¬
- `examples/test_stateful_session.py` - ä¼šè¯åŠŸèƒ½æµ‹è¯•

### æµ‹è¯•å†…å®¹
1. âœ… ä¼šè¯åˆ›å»ºå’Œ ID è¿”å›
2. âœ… ä¼šè¯å¤ç”¨ï¼ˆæºå¸¦ Mcp-Session-Idï¼‰
3. âœ… æ— æ•ˆä¼šè¯ ID è¿”å› 401
4. â„¹ï¸ ä¼šè¯è¶…æ—¶ï¼ˆéœ€è¦ç­‰å¾…è¶…æ—¶æ—¶é—´ï¼‰

### è¿è¡Œæµ‹è¯•
```bash
# å¯åŠ¨æœåŠ¡å™¨
uv run python -m mcp2anp.server_remote \
  --host 0.0.0.0 \
  --port 9880 \
  --session-timeout 60 \
  --cleanup-interval 30

# è¿è¡Œæµ‹è¯•
uv run python examples/test_stateful_session.py
```

## ä»£ç é‡æ„

### æ¨¡å—åˆ†ç¦»
- **é‡æ„å‰**: æ‰€æœ‰ä»£ç åœ¨ `server_remote.py`ï¼ˆ690 è¡Œï¼‰
- **é‡æ„å**: 
  - `session.py`ï¼ˆ226 è¡Œï¼‰- ä¼šè¯ç®¡ç†
  - `server_remote.py`ï¼ˆ490 è¡Œï¼‰- æœåŠ¡å™¨é€»è¾‘

### ä¼˜åŠ¿
1. âœ… æ¨¡å—åŒ–ï¼šèŒè´£æ¸…æ™°
2. âœ… å¯æµ‹è¯•ï¼šå¯ç‹¬ç«‹æµ‹è¯•ä¼šè¯æ¨¡å—
3. âœ… å¯å¤ç”¨ï¼šä¼šè¯æ¨¡å—å¯åœ¨å…¶ä»–é¡¹ç›®ä¸­ä½¿ç”¨
4. âœ… å¯ç»´æŠ¤ï¼šä»£ç ç»„ç»‡æ›´æ¸…æ™°

## é…ç½®å»ºè®®

### å¼€å‘ç¯å¢ƒ
```bash
--session-timeout 600      # 10 åˆ†é’Ÿ
--cleanup-interval 60      # 1 åˆ†é’Ÿæ¸…ç†
```

### ç”Ÿäº§ç¯å¢ƒ
```bash
--session-timeout 3600     # 1 å°æ—¶
--cleanup-interval 300     # 5 åˆ†é’Ÿæ¸…ç†
```

### é«˜è´Ÿè½½ç¯å¢ƒ
```bash
--session-timeout 300      # 5 åˆ†é’Ÿ
--cleanup-interval 60      # 1 åˆ†é’Ÿæ¸…ç†
```

## æ€§èƒ½ç‰¹æ€§

### å†…å­˜ä½¿ç”¨
- æ¯ä¸ªä¼šè¯ï¼šçº¦ 10-100KBï¼ˆå–å†³äº ANPCrawler ç¼“å­˜ï¼‰
- 1000 ä¸ªä¼šè¯ï¼šçº¦ 10-100MB

### æ¸…ç†ä»»åŠ¡å¼€é”€
- æ—¶é—´å¤æ‚åº¦ï¼šO(n)ï¼Œn ä¸ºä¼šè¯æ€»æ•°
- 1000 ä¸ªä¼šè¯ï¼š< 1ms
- 10000 ä¸ªä¼šè¯ï¼š< 10ms

## æ–‡æ¡£

### æ–°å¢æ–‡æ¡£
- `docs/SESSION_LIFECYCLE.md` - ä¼šè¯ç”Ÿå‘½å‘¨æœŸè¯¦ç»†æ–‡æ¡£
- `docs/STATEFUL_SESSION.md` - æœ‰çŠ¶æ€ä¼šè¯ä½¿ç”¨æŒ‡å—
- `SESSION_IMPLEMENTATION_SUMMARY.md` - æœ¬æ–‡æ¡£

### æ›´æ–°æ–‡æ¡£
- `REFACTORING_SUMMARY.md` - ä»£ç é‡æ„æ€»ç»“
- `STATEFUL_SESSION_CHANGES.md` - ä¼šè¯åŠŸèƒ½å˜æ›´è®°å½•

## æ–‡ä»¶æ¸…å•

### æ–°å¢æ–‡ä»¶
- `mcp2anp/session.py` - ä¼šè¯ç®¡ç†æ¨¡å—
- `docs/SESSION_LIFECYCLE.md` - ä¼šè¯ç”Ÿå‘½å‘¨æœŸæ–‡æ¡£
- `docs/STATEFUL_SESSION.md` - ä½¿ç”¨æŒ‡å—
- `examples/test_stateful_session.py` - æµ‹è¯•è„šæœ¬

### ä¿®æ”¹æ–‡ä»¶
- `mcp2anp/server_remote.py` - é›†æˆä¼šè¯ç®¡ç†
- `mcp2anp/__init__.py` - å¯¼å‡ºä¼šè¯ç±»

### åˆ é™¤æ–‡ä»¶
- `examples/test_session_basic.py` - å·²åˆ é™¤ï¼ˆä¸å†éœ€è¦ï¼‰

## æœªæ¥æ”¹è¿›

### çŸ­æœŸ
- [ ] æ·»åŠ ä¼šè¯ç»Ÿè®¡æ¥å£
- [ ] æ·»åŠ ä¼šè¯ç›‘æ§æ—¥å¿—
- [ ] ä¼˜åŒ–æ¸…ç†ä»»åŠ¡æ€§èƒ½

### ä¸­æœŸ
- [ ] ä¼šè¯æŒä¹…åŒ–ï¼ˆRedisï¼‰
- [ ] å¤šæœåŠ¡å™¨æ”¯æŒ
- [ ] æŒ‰ç”¨æˆ·é™åˆ¶ä¼šè¯æ•°

### é•¿æœŸ
- [ ] ä¼šè¯è¿ç§»å’Œè´Ÿè½½å‡è¡¡
- [ ] ä¼˜é›…å…³é—­æ—¶ä¿å­˜ä¼šè¯
- [ ] å¦‚æœ MCP åè®®æ”¯æŒï¼Œæ·»åŠ ä¸»åŠ¨å…³é—­åŠŸèƒ½

## æ€»ç»“

âœ… **å®ç°å®Œæˆ**
- åŸºäºè¶…æ—¶çš„ä¼šè¯ç®¡ç†
- æ¨¡å—åŒ–ä»£ç ç»“æ„
- å®Œæ•´çš„æ–‡æ¡£å’Œæµ‹è¯•

âœ… **åŠŸèƒ½éªŒè¯**
- ä¼šè¯åˆ›å»ºå’Œå¤ç”¨æ­£å¸¸
- è¶…æ—¶æ¸…ç†æœºåˆ¶å·¥ä½œæ­£å¸¸
- æœåŠ¡å™¨ç¨³å®šè¿è¡Œ

âœ… **ä»£ç è´¨é‡**
- æ—  linter é”™è¯¯
- è‰¯å¥½çš„ç±»å‹æ³¨è§£
- å®Œæ•´çš„æ–‡æ¡£å­—ç¬¦ä¸²

ğŸ‰ **é¡¹ç›®çŠ¶æ€ï¼šå¯ç”¨äºç”Ÿäº§ç¯å¢ƒ**
